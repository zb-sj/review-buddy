# Visual Discovery (Phase 1.5)

You are performing a specialized discovery phase to gather visual context for the review. Your goal is to fetch designs, identify regression snapshots, and prepare side-by-side comparisons.

## Prerequisites

- Phase 1 (Context Assembly) completed
- `visual_changes_detected` is true OR `visual_mode` argument is set

## Steps

### 1. Figma Discovery

If Figma URLs were detected in the PR metadata or description:
1. **Extract Keys**: For each URL, extract the `fileKey` and `nodeId` (e.g., `figma.com/design/:fileKey/.../?node-id=:nodeId`).
2. **Fetch Design Context**: Use `get_design_context` to fetch the design metadata and code snippets for the linked nodes.
3. **Generate Screenshots**: Use `get_screenshot` for each linked node to get a visual baseline of what the design *should* look like.
4. **Identify Variables**: Use `get_variable_defs` to understand design tokens (colors, spacing) used in the design.

### 2. Regression Snapshot Discovery (Playwright/Cypress)

If snapshot files (`**/snapshots/*.png`) are in the `changed_files` list:
1. **Identify Pairs**: Match "expected" (baseline) vs "actual" (new) snapshots. Often these are separate files or a diff image generated by the test runner.
2. **Read Diff Content**: If the test runner provides a `{test-name}-diff.png`, prioritize fetching that.
3. **Contextualize**: Link snapshots to the components or pages they represent based on file paths.

### 3. Mobile Discovery (MobileMCP)

If the project is mobile-based (React Native, Flutter, Swift, Kotlin):
1. **Check MobileMCP**: If MobileMCP tools are available, prepare to use them for device-specific visual inspection.
2. **Asset Inspection**: Identify new or modified image assets in mobile folders (`ios/`, `android/`).

### 4. Interactive Fallback & Tool Guidance

If no automated visual context (Figma/Snapshots) can be retrieved:
1. **Prompt User**: Inform the user that visual changes were detected but no automated baselines were found.
2. **Ask for Screenshots**: Invite the user to provide manual screenshots or screen recordings of the changes.
3. **Tool Recommendations**:
   - "ðŸ’¡ Pro-tip: Include a Figma link in your PR description for automated design comparison."
   - "ðŸ’¡ Pro-tip: Use Playwright's visual regression testing to capture and compare snapshots automatically."

### 5. Display Visual Overview

Present a summary of the discovered visual context:

```
### Visual Context Discovered

- **Figma Designs**: {count} nodes found (e.g., [Node Name](url))
- **Regression Snapshots**: {count} pairs identified
- **Mobile Assets**: {count} images changed
```

### 6. User Gate

**Select an action:**
1. **Proceed with Visual Review** â€” Include visual analysis in Phase 4
2. **Skip Visual Review** â€” Continue with standard code-only review
3. **Refresh Context** â€” Re-run discovery (e.g., if Figma links were just added)

### 7. Output

Store the following for use by Phase 4:
- `figma_assets` â€” map of nodeId â†’ {screenshot_url, metadata, code_context}
- `regression_pairs` â€” list of {expected, actual, diff} snapshot paths
- `mobile_assets` â€” list of changed mobile images
- `visual_review_enabled` â€” boolean
